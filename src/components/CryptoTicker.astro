---
// CryptoTicker component with real-time data from Binance API
---

<div class="crypto-ticker">
  <div class="crypto-ticker-content" id="crypto-ticker-content">
    <!-- Loading placeholder -->
    <div class="crypto-pair loading-placeholder">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold text-sm animate-pulse">...</div>
        <div>
          <div class="text-white font-semibold">Cargando...</div>
          <div class="text-gray-300 text-sm font-medium">Obteniendo precios</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Trading pairs configuration
const TRADING_PAIRS = [
  {
    symbol: 'BTCUSDT',
    display: 'BTC/USD',
    icon: '₿',
    color: 'bg-orange-500',
    api: 'binance'
  },
  {
    symbol: 'ETHUSDT',
    display: 'ETH/USD',
    icon: 'Ξ',
    color: 'bg-blue-500',
    api: 'binance'
  },
  {
    symbol: 'BNBUSDT',
    display: 'BNB/USD',
    icon: 'B',
    color: 'bg-yellow-500',
    api: 'binance'
  }
];

let previousPrices:any = {};

// Fetch crypto prices from Binance
async function fetchBinancePrices() {
  try {
    const cryptoSymbols = TRADING_PAIRS
      .filter(pair => pair.api === 'binance')
      .map(pair => pair.symbol);
    
    const promises = cryptoSymbols.map(symbol => 
      fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`)
        .then(res => res.json())
    );
    
    const results = await Promise.all(promises);
    const prices:any = {};
    
    results.forEach((result, index) => {
      if (result.price) {
        prices[cryptoSymbols[index]] = parseFloat(result.price);
      }
    });
    
    return prices;
  } catch (error) {
    console.error('Error fetching Binance prices:', error);
    return {};
  }
}


// Calculate price change percentage
function calculateChange(current:any, previous:any) {
  if (!previous) return 0;
  return ((current - previous) / previous) * 100;
}

// Format price based on currency type
function formatPrice(price:any, symbol:any) {
  if (symbol.includes('USD') && !symbol.includes('JPY')) {
    return `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  } else if (symbol === 'JPYUSD') {
    return `¥${(1/price).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
  } else {
    return price.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
  }
}

// Create ticker item HTML
function createTickerItem(pair:any, price:any) {
  const change = calculateChange(price, previousPrices[pair.symbol]);
  const isPositive = change >= 0;
  const changeClass = isPositive ? 'text-green-300' : 'text-red-300';
  const changeSymbol = isPositive ? '+' : '';
  
  return `
    <div class="crypto-pair">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 ${pair.color} rounded-full flex items-center justify-center text-white font-bold text-sm">${pair.icon}</div>
        <div>
          <div class="text-white font-semibold">${pair.display}</div>
          <div class="${changeClass} text-sm font-medium">
            ${formatPrice(price, pair.symbol)} ${changeSymbol}${change.toFixed(2)}%
          </div>
        </div>
      </div>
    </div>
  `;
}

// Update ticker with fresh data
async function updateTicker() {
  try {
    const binancePrices = await fetchBinancePrices();
    
    const allPrices:any = { ...binancePrices };
    
    const tickerContent = document.getElementById('crypto-ticker-content');
    if (tickerContent && Object.keys(allPrices).length > 0) {
      // Create ticker items
      let tickerHTML = '';
      
      TRADING_PAIRS.forEach(pair => {
        if (allPrices[pair.symbol]) {
          tickerHTML += createTickerItem(pair, allPrices[pair.symbol]);
        }
      });
      
      // Duplicate for continuous scroll
      tickerHTML += tickerHTML;
      
      tickerContent.innerHTML = tickerHTML;
      
      // Update previous prices for next comparison
      previousPrices = { ...allPrices };
    }
  } catch (error) {
    console.error('Error updating ticker:', error);
  }
}

// Initialize ticker
document.addEventListener('DOMContentLoaded', () => {
  updateTicker();
  
  // Update every 10 seconds
  setInterval(updateTicker, 10000);
});
</script>